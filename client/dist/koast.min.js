angular.module("koast.http",[]).factory("_koastTokenKeeper",["$log","$window",function(e,t){var n="KoastToken",r={};return r.saveToken=function(e){var r=e.token;t.localStorage.setItem(n,r)},r.loadToken=function(){return t.localStorage.getItem(n)},r.clear=function(){return t.localStorage.removeItem(n)},r}]).factory("_koastHttp",["$http","$q","_koastLogger","_koastTokenKeeper",function(e,t,n,r){function o(){c.headers=c.headers||{},l&&(c.headers.Authorization="Bearer "+l)}function a(){return t.when()}function i(e){return a().then(function(){o()}).then(e).then(function(e){return s.isReachable=!0,e.data?e.data:e}).then(null,function(e){throw u.warn(e.data||e),e})}var u=n.makeLogger("koast.http"),s={},c={timeout:3e4},l=r.loadToken();return u.debug("Loaded token",l),s.setOptions=function(e){c=e},s.saveToken=function(e){r.saveToken(e)},s.deleteToken=function(){r.clear()},s.get=function(t,n){return i(function(){var r=_.cloneDeep(c);return r.url=c.baseUrl+t,r.params=n,r.method="GET",e(r)})},s}]),angular.module("koast",["koast-user","koast-resource"]).factory("koast",["_koastUser","_koastResourceGetter","$log",function(e,t,n){"use strict";var r={},o=["setApiUriPrefix","getResource","createResource","queryForResources","addEndpoint"];return r.user=e,o.forEach(function(e){r[e]=t[e]}),r.init=function(t){n.info("Initializing koast."),e.init(t)},r}]),angular.module("koast.logger",[]).factory("_koastLogger",[function(){function e(e,t,n){if(e=arguments[0]||{},!(e.level&&e.level<r)){var o=e.color||"black",a=[];n=Array.prototype.slice.call(n,0);var i=[];"string"==typeof n[0]&&(i.push("%c"+n.shift()),a.push("color:"+o+";")),t.groupName&&(i.unshift("%c["+t.groupName+"]"),a.unshift("color:gray;")),e.symbol&&(i.unshift("%c"+e.symbol),a.unshift("color:"+o+";font-weight:bold;font-size:150%;")),a.unshift(i.join(" ")),a=a.concat(n),Function.prototype.apply.call(console.log,console,a)}}function t(t){return t.level=n.levels[t.name],function(n,r){e(t,n,r)}}var n={};n.levels={debug:1,verbose:2,info:3,warn:4,error:5};var r=3;n.colors={},n.setLogLevel=function(e){r=e};var o={debug:t({name:"debug",color:"gray",symbol:"✍"}),verbose:t({name:"verbose",color:"cyan",symbol:"☞"}),info:t({name:"info",color:"#0074D9",symbol:"☞"}),warn:t({name:"warn",color:"orange",symbol:"⚐"}),error:t({name:"error",color:"red",symbol:"⚑"})},a=["debug","verbose","info","warn","error"];n.makeLogger=function(e){var t={};return"string"==typeof e&&(e={groupName:e}),t.options=e,a.forEach(function(e){t[e]=function(){var n=arguments;return o[e](t.options,n)}}),t};var i=n.makeLogger({});return a.forEach(function(e){n[e]=i[e]}),n}]),angular.module("koast-persona",[]).factory("_koastPersona",["$http","$q","$interval","$location","$log",function(e,t,n,r,o){"use strict";function a(){var e,r=window.document,o=r.getElementsByTagName("head")[0],a=r.createElement("script"),i=t.defer();return a.type="text/javascript",a.async=!0,a.src="https://login.persona.org/include.js",o.appendChild(a),e=n(function(){window.navigator.id&&(i.resolve(),n.cancel(e))},50),i.promise}function i(t){o.debug("verifyAssertion:");var n=r.absUrl().split("/").slice(0,3).join("/")+"/",a={assertion:t,audience:n};o.info("audience:",n);var i={timeout:5e3};return e.post("/auth/browserid",a,i).then(function(e){return o.debug("Response:",e),e.data}).then(null,function(e){throw"object"==typeof e&&e.headers?(o.error("Persona verification timed out."),new Error("Persona verification timed out.")):(o.error("Error verifying Persona assertion:",e.toString()),o.error(e.stack),e)})}var u={},s=!1,c=t.defer();return u.initiateSignIn=function(e){e||(e={}),o.debug("signIn"),s=!0,navigator.id.request({siteName:e.siteTitle,oncancel:function(){o.info("Persona login cancelled by user.")}})},u.initiateSignOut=function(){s=!0,navigator.id.logout()},u.init=function(e){return a().then(function(){o.debug("navigator.id.watch added"),navigator.id.watch({loggedInUser:null,onlogin:function(t){s&&i(t).then(function(t){e.onSignIn(t)},o.error)},onlogout:function(){s&&e.onSignOut()},onready:function(){c.resolve()}})}).then(null,o.error),c.promise},u.whenReady=function(){return c.promise},u}]),angular.module("koast-resource",["koast-user"]).factory("_KoastServerHelper",["_koastUser",function(e){"use strict";var t={};return t.addAuthHeaders=function(t){e.isSignedIn&&(t["koast-auth-token"]=e.meta.authToken,t["koast-auth-token-timestamp"]=e.meta.timestamp,t["koast-user"]=angular.toJson(e.data))},t}]).factory("_KoastResource",["_KoastServerHelper","$q","$http","$log",function(e,t,n,r){"use strict";function o(e,t,n){var r,o=this;if(n.useEnvelope){if(r=t.data,!r)throw new Error("Client expects an envelope, but server did not send it properly.")}else r=t;return _.keys(r).forEach(function(e){o[e]=r[e]}),n.useEnvelope&&Object.defineProperty(this,"can",{get:function(){return t.meta.can}}),Object.defineProperty(this,"_endpoint",{get:function(){return e}}),this}return o.prototype.save=function(){var t=this._endpoint.makeGetUrl(this),r={};return e.addAuthHeaders(r),n.put(t,this,{headers:r})},o.prototype.delete=function(){r.debug("The endpoint: ",this._endpoint);var t=this._endpoint.makeGetUrl(this);r.debug("delete url:",t);var o={};return e.addAuthHeaders(o),n.delete(t,{headers:o})},o}]).factory("_KoastEndpoint",[function(){"use strict";function e(e,t,n,r){var o=this;o.prefix=e,o.handle=t,o.template=n,o.options=_.clone(r)}function t(e,t){return t?e.replace(/:([-_a-zA-Z]*)/g,function(e,n){var r=t[n],o=r||0===r;if(!o)throw new Error("Missing parameter: "+n);return t[n]}):""}return e.prototype.makePostUrl=function(){return this.prefix+this.handle},e.prototype.makeGetUrl=function(e){return this.makePostUrl()+"/"+t(this.template,e)},e}]).factory("_koastResourceGetter",["_KoastResource","_KoastServerHelper","_KoastEndpoint","$http","$q","$log",function(e,t,n,r,o,a){"use strict";function i(t,n){var r=_.map(t,function(t){return new e(n.endpoint,t,n)});return n.singular&&(0===r.length?r=null:r.length>1?(a.warn("Expected a singular resource, got "+r.length),r=r[0]):r=r[0]),r}function u(e,n,o,a){var u=d[e],s={},c={},l={params:o,headers:s};if(c=angular.extend(c,u.options),c=angular.extend(c,a),c.endpoint=u,!u)throw new Error("Unknown endpoint: "+e);return t.addAuthHeaders(s),r.get(u.makeGetUrl(n),l).then(function(e){return i(e.data,c)})}function s(e,n,a){var i=o.defer(),u=d[e],s={};if(a=a||{},!u)throw new Error("Unknown endpoint: "+e);return t.addAuthHeaders(s),r.post(u.makePostUrl(),n,{headers:s}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise}var c={},l={},d={};return c.setApiUriPrefix=function(e,t){t=t||"_",l[t]=e},c.getResource=function(e,t){return u(e,t,null,{singular:!0})},c.createResource=function(e,t){return s(e,t).then(null,a.error)},c.queryForResources=function(e,t){return u(e,null,t)},c.addEndpoint=function(e,t,r){r=r||{};var o=r.server||"_",a=l[o];if(!a)throw new Error("No URI prefix defined for server "+o);var i=new n(a,e,t,r);if(d[e])throw new Error("An endpoint with this handle was already defined: "+e);d[e]=i},c}]),angular.module("koast-user",["koast.logger","koast.http"]).factory("_koastOauth",["$window","$location","$log","_koastLogger",function(e,t,n,r){"use strict";function o(e,t){return i+"/auth/"+e+"?next="+encodeURIComponent(t)}var a={},i=t.absUrl().split("/").slice(0,3).join("/");return a.initiateAuthentication=function(n){var r=o(n,t.absUrl());e.location.replace(r)},a.setBaseUrl=function(e){i=e},a.makeRequestURL=function(e){return e||(e=""),i+e},a}]).factory("_koastUser",["_koastOauth","_koastHttp","_koastLogger","$log","$timeout","$http","$window","$q",function(e,t,n,r,o,a,i,u){"use strict";function s(e){var t=m.debug.delay;return t?(r.debug("Delayng for "+t+" msec."),o(function(){return e},t)):e}function c(e){var t=e&&e.data;return h.debug("Setting the user based on",e.data),t?(e.isAuthenticated&&(m.data=e.data,m.meta=e.meta,m.meta.token&&p.saveToken({token:m.meta.token,expires:m.meta.expires}),k.resolve()),m.isAuthenticated=e.isAuthenticated):(h.warn("Did not get back a valid user record.",e),m.data={},m.isAuthenticated=!1,m.meta={}),m.isReady=!0,m.isAuthenticated}function l(e){return e&&!m.meta.isRegistered&&f?o(f,0).then(function(){return e}):e}function d(e){return p.get(e||"/auth/user").then(null,function(e){if(401===e.status)return null;throw e}).then(s).then(c).then(l)}var f,g,h=n.makeLogger("koast.user"),p=t,m={isAuthenticated:!1,isReady:!1,data:{},meta:{}},k=u.defer();return m.initiateOauthAuthentication=function(t){e.initiateAuthentication(t)},m.logout=function(t){return p.deleteToken(),a.post(e.makeRequestURL("/auth/logout")).then(function(e){if("Ok"!==e.data)throw new Error("Failed to logout.");i.location.replace(t||"/")}).then(null,function(e){throw r.error(e),e})},m.loginLocal=function(t){r.debug("Login:",t.username);var n={username:t.username,password:t.password};return a.post(e.makeRequestURL("/auth/login"),n).then(function(e){return h.debug("loginLocal:",e),e.data}).then(c)},m.registerSocial=function(t){return a.put(e.makeRequestURL("/auth/user"),t).then(function(){return d()})},m.registerLocal=function(t){return a.post(e.makeRequestURL("/auth/user"),t)},m.checkUsernameAvailability=function(t){var n=e.makeRequestURL("/auth/usernameAvailable");return a.get(n,{params:{username:t}}).then(function(e){return"true"===e.data}).then(null,r.error)},m.resetPassword=function(t){return a.post(e.makeRequestURL("/forgot"),{email:t})},m.setNewPassword=function(t,n){return a.post(e.makeRequestURL("/reset/"+n),{password:t})},m.setRegistrationHanler=function(e){f=e},m.getStatusPromise=function(){return g||(g=d()),g},m.whenStatusIsKnown=m.getStatusPromise,m.init=function(t){return t.debug=t.debug||{},m.debug=t.debug,p.setOptions(t),e.setBaseUrl(t.baseUrl),m.getStatusPromise()},m.whenAuthenticated=function(){return k.promise},m}]);